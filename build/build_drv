#!/usr/bin/ksh

# This script assumes that build_lib and install_lib have been run already.

cmplr=gcc
c_flags="-m64"
c_flag_myskl="-D MYSKL"
c_flag_librb="-D LIBREDBLACK"
c_inc="-I /opt/libslablist/include -I /opt/myskl/include -I /opt/libredblack/include"
ld_flags="-R /opt/libslablist/lib/64:/opt/libslablist/lib:/opt/libredblack/lib:/opt/myskl/lib"
#ld_flags=""
libs1="-lc -lumem -luutil -L /opt/libslablist/lib/64 -lslablist"
#libs2=" -L /opt/myskl/lib/ -lmyskl -L /opt/libredblack/lib/ -lredblack"
libs=$libs1$libs2
#libs="-lc -lumem -lslablist"
src_dir="../src"

ds_src[1]=bst.c
ds_src[2]=bsts.c
ds_src[3]=pavl.c
ds_src[4]=pbst.c
ds_src[5]=prb.c
ds_src[6]=rb.c
ds_src[7]=rtavl.c
ds_src[8]=rtbst.c
ds_src[9]=rtrb.c
ds_src[10]=tavl.c
ds_src[11]=tbst.c
ds_src[12]=trb.c
ds_src[13]=bt_code.c
ds_src[14]=avl.c
ds_src[15]=skiplist.c

ds_obj[1]=bst.o
ds_obj[2]=bsts.o
ds_obj[3]=pavl.o
ds_obj[4]=pbst.o
ds_obj[5]=prb.o
ds_obj[6]=rb.o
ds_obj[7]=rtavl.o
ds_obj[8]=rtbst.o
ds_obj[9]=rtrb.o
ds_obj[10]=tavl.o
ds_obj[11]=tbst.o
ds_obj[12]=trb.o
ds_obj[13]=bt_code.o
ds_obj[14]=avl.o
ds_obj[15]=skiplist.o

drv_src[1]=drv_gen.c
drv_src[2]=drv_rand_ops.c
drv_src[3]=drv_ranged_ops.c

drv_obj[1]=drv_gen.o
drv_obj[2]=drv_ranged_ops.o
drv_obj[3]=drv_rand_ops.o

drv_cmd[1]=drv_gen
drv_cmd[2]=drv_ranged_ops
drv_cmd[3]=drv_rand_ops

struc_prov="../drv/struc_provider.d" 
struc_provo="struc_provider.o" 

dtrace -h -s $struc_prov -o ../drv/struc_provider.h

#Here we compile the data struct files
print "Compiling Data Structure Files"
for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
do
	$cmplr -c $c_flags "../drv/"${ds_src[$i]} #$libs
done

print "Compiling Driver Files"
for i in 1 #2 3
do
	$cmplr -c $c_inc $c_flags "../drv/"${drv_src[$i]} #$libs
done

print "Generating DTrace Bin"
dtrace -G -64 -s $struc_prov ${drv_obj[$i]} -o $struc_provo

obj_line=$struc_provo" "
for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
do
	obj_line=$obj_line${ds_obj[$i]}" "
done


print "Generating Drivers"
for i in 1 #2 3
do
	$cmplr $c_flags -o ${drv_cmd[$i]} ${drv_obj[$i]} $obj_line $ld_flags $libs 
done
