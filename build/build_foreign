#!/usr/bin/ksh

# make's complete lack of conditionals (aside from conditional macros) makes it
# a massive pain to work with. Couple that with lack of loops and it's outright
# torturous. I'm all for using the right tool for the job, and make is not it.
# Ksh, on the other hand, is a better tool for the job. Though, not the ideal
# tool.

# Maybe there is an elegant way to do this in `make`, but at any rate I don't
# know it. At least this script is runnable via ksh, which is the same on every
# platform. `make` syntax varies from OS to OS. For example, conditional macro
# syntax is different between Illumos make and GNU make. So even if there is a
# more elegant way to build this via `make`, it is probably going to be less
# portable.

#Yeah, this violates the CAPS convention, but is easier to read.
#cmplr=cc
#c_flags="-m64 -Kpic"
#ld_flags="-G -z text -z defs"
cmplr=gcc
c_flags="-m64 -W -Wall"
umem_c_flags=$c_flags" -Wno-unused-parameter"
ld_flags="-shared"

libs="-lc"

#COMMON
struc_prov="../common/struc_provider.d"
struc_provh="../common/struc_provider.h"
struc_provo="../common/struc_provider.o"
subdir="gnubst"

dtrace -h -s $struc_prov -o $struc_provh

#GNU BST
subdir="gnubst"
gcc -m64 -c ../gnubst/bst.c -o ../gnubst/bst.o
gcc -m64 -c ../gnubst/drv_gnubst.c -o ../gnubst/drv_gnubst.o
dtrace -G -64 -s $struc_prov ../gnubst/bst.o ../gnubst/drv_gnubst.o -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnubst ../gnubst/bst.o ../gnubst/drv_gnubst.o ../gnubst/bst_provider.o -lumem -lc


#GNU PAVL
subdir="gnupavl"
gcc -m64 -c ../gnupavl/pavl.c -o ../gnupavl/pavl.o
impl="pavl.o"
gcc -m64 -c ../gnupavl/drv_gnupavl.c -o ../gnupavl/drv_gnupavl.o
drv="drv_gnupavl.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnupavl ../gnupavl/pavl.o ../gnupavl/drv_gnupavl.o ../gnupavl/avl_provider.o -lumem -lc

#GNU PRB
subdir="gnuprb"
gcc -m64 -c ../gnuprb/prb.c -o ../gnuprb/prb.o
impl="prb.o"
gcc -m64 -c ../gnuprb/drv_gnuprb.c -o ../gnuprb/drv_gnuprb.o
drv="drv_gnuprb.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnuprb ../gnuprb/prb.o ../gnuprb/drv_gnuprb.o ../gnuprb/rb_provider.o -lumem -lc

#GNU RB
subdir="gnurb"
gcc -m64 -c ../gnurb/rb.c -o ../gnurb/rb.o
impl="rb.o"
gcc -m64 -c ../gnurb/drv_gnurb.c -o ../gnurb/drv_gnurb.o
drv="drv_gnurb.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnurb ../gnurb/rb.o ../gnurb/drv_gnurb.o ../gnurb/rb_provider.o -lumem -lc


#GNU RTAVL
subdir="gnurtavl"
gcc -m64 -c ../gnurtavl/rtavl.c -o ../gnurtavl/rtavl.o
impl="rtavl.o"
gcc -m64 -c ../gnurtavl/drv_gnurtavl.c -o ../gnurtavl/drv_gnurtavl.o
drv="drv_gnurtavl.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnurtavl ../gnurtavl/rtavl.o ../gnurtavl/drv_gnurtavl.o ../gnurtavl/avl_provider.o -lumem -lc

#GNU TAVL
subdir="gnutavl"
gcc -m64 -c ../gnutavl/tavl.c -o ../gnutavl/tavl.o
impl="tavl.o"
gcc -m64 -c ../gnutavl/drv_gnutavl.c -o ../gnutavl/drv_gnutavl.o
impl="drv_gnutavl.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_gnutavl ../gnutavl/tavl.o ../gnutavl/drv_gnutavl.o ../gnutavl/avl_provider.o -lumem -lc

#GNU JMPC BTREE
subdir="jmpc_btree"
gcc -m64 -c ../jmpc_btree/bt_code.c -o ../jmpc_btree/bt_code.o
impl="bt_code.o"
gcc -m64 -c ../jmpc_btree/drv_jmpcbt.c -o ../jmpc_btree/drv_jmpcbt.o
drv="drv_jmpcbt.o"
dtrace -G -64 -s $struc_prov ../$subdir/$impl ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_jmpcbt ../jmpc_btree/bt_code.o ../jmpc_btree/drv_jmpcbt.o ../jmpc_btree/bt_provider.o -lumem -lc
cp drv_jmpcbt drv_jmpcbt_512
cp drv_jmpcbt drv_jmpcbt_1024
cp drv_jmpcbt drv_jmpcbt_4096

libs="-ldtrace -lumem -lc -luutil"

#Illumos UUAVL
subdir="uuavl"
gcc -m64 -c ../uuavl/drv_uuavl.c -o ../uuavl/drv_uuavl.o
drv="drv_uuavl.o"
dtrace -G -64 -s $struc_prov ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_uuavl ../uuavl/drv_uuavl.o ../uuavl/struc_provider.o $libs

#Illumos UULIST
subdir="uulist"
#gcc -m64 -c ../uulist/uulist.c -o ../uulist/uulist.o
gcc -m64 -c ../uulist/drv_uulist.c -o ../uulist/drv_uulist.o
drv="drv_uulist.o"
dtrace -G -64 -s $struc_prov ../$subdir/$drv -o ../$subdir/struc_provider.o
gcc -m64 -o drv_uulist ../uulist/drv_uulist.o ../uulist/uulist_provider.o $libs
